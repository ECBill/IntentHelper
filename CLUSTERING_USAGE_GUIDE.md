# 语义聚类功能使用示例

## 📖 功能概述

语义聚类功能通过分析事件节点的向量表示（embedding），自动将语义相似的事件组织成聚类，从而：
- 减少查询干扰
- 提高检索效率  
- 提供更高层次的知识组织
- 支持多粒度的信息浏览

## 🎯 适用场景

### 场景1：整理学习笔记
假设你记录了多次关于"机器学习"的讨论：
```
事件1: 讨论神经网络基础概念
事件2: 学习卷积神经网络
事件3: 研究注意力机制
事件4: 阅读Transformer论文
```

聚类后会自动生成：
```
聚类: "深度学习相关研究 (4个)"
├── 讨论神经网络基础概念
├── 学习卷积神经网络
├── 研究注意力机制
└── 阅读Transformer论文
```

### 场景2：归档项目讨论
项目期间的多次会议和讨论：
```
事件1: 项目启动会议
事件2: 技术方案讨论
事件3: 进度同步会
事件4: 问题复盘会
```

聚类后：
```
聚类: "XX项目相关会议 (4个)"
├── 项目启动会议 (01/15)
├── 技术方案讨论 (01/20)
├── 进度同步会 (01/27)
└── 问题复盘会 (02/03)
```

### 场景3：生活日记聚类
```
事件1: 周末去星巴克写代码
事件2: 下午在咖啡厅看书
事件3: 周日咖啡店闲聊
```

聚类后：
```
聚类: "咖啡厅日常 (3个)"
├── 周末去星巴克写代码
├── 下午在咖啡厅看书
└── 周日咖啡店闲聊
```

## 🔧 操作步骤

### 步骤1：准备数据

确保你的事件节点已经生成了embedding向量：

1. 打开应用，进入"知识图谱调试工具"页面
2. 切换到"图谱维护"标签页
3. 点击"为所有事件生成向量"按钮
4. 等待向量生成完成

**验证方法**：
- 切换到"数据验证"标签页
- 点击"检查事件 embedding"按钮
- 确认所有事件都有非空的embedding

### 步骤2：执行聚类

1. 在"图谱维护"标签页
2. 点击"整理图谱（语义聚类）"按钮
3. 等待聚类完成（通常5-30秒）

聚类进度会实时显示：
```
开始语义聚类...
找到 48 个候选事件
正在聚类...
生成了 7 个聚类
生成聚类摘要 1/7...
生成聚类摘要 2/7...
...
保存聚类结果...
聚类完成！耗时 12 秒
```

### 步骤3：查看聚类结果

聚类完成后：

1. 点击对话框中的"查看聚类"按钮
2. 或手动切换到"聚类管理"标签页

你会看到：
- 聚类统计面板：显示聚类总数、平均大小等
- 聚类列表：每个聚类显示为可折叠卡片

### 步骤4：浏览聚类内容

点击任意聚类卡片展开，查看：
- 聚类标题和描述
- 成员事件数量
- 时间跨度
- 所有成员事件列表

点击成员事件可查看详细信息。

## ⚙️ 调整参数

如果聚类效果不理想，可以在 `semantic_clustering_service.dart` 中调整参数：

```dart
// 相似度阈值 - 越高越严格（默认0.85）
static const double SIMILARITY_THRESHOLD = 0.85;

// 时间窗口 - 聚类成员的最大时间跨度（默认30天）
static const int TEMPORAL_WINDOW_DAYS = 30;

// 最小聚类大小 - 小于此值的聚类会被忽略（默认2）
static const int MIN_CLUSTER_SIZE = 2;

// 最大聚类大小 - 防止聚类过大（默认20）
static const int MAX_CLUSTER_SIZE = 20;
```

### 参数调优建议

**问题：聚类太少**
- 降低 `SIMILARITY_THRESHOLD` (如 0.80)
- 增大 `TEMPORAL_WINDOW_DAYS` (如 60)

**问题：聚类太多或太碎片化**
- 提高 `SIMILARITY_THRESHOLD` (如 0.90)
- 减小 `TEMPORAL_WINDOW_DAYS` (如 14)

**问题：聚类包含不相关事件**
- 提高 `SIMILARITY_THRESHOLD`
- 检查事件的embedding质量
- 确保事件描述足够详细准确

**问题：重要事件没被聚类**
- 降低 `MIN_CLUSTER_SIZE` 为 1（允许单事件聚类）
- 检查该事件是否有embedding
- 检查该事件的时间是否在窗口内

## 🔍 聚类感知的向量查询

聚类完成后，向量查询会自动优化：

### 查询行为变化

**之前**：
```
用户查询: "机器学习"
返回: 10个独立的事件节点
```

**聚类后**：
```
用户查询: "机器学习"
返回: 
  - 聚类: "深度学习相关研究 (4个)" [可展开]
  - 聚类: "机器学习项目讨论 (3个)" [可展开]
  - 事件: 其他独立事件...
```

### 优势

1. **减少重复**：相似事件合并为聚类，避免返回大量相似结果
2. **提高效率**：聚类摘要节点代表一组事件，减少结果数量
3. **支持展开**：需要时可展开聚类查看所有成员
4. **过滤合并节点**：已被合并的原始事件自动过滤，不会重复出现

## 📊 统计与监控

### 查看聚类统计

在"聚类管理"标签页顶部，统计面板显示：

- **聚类总数**：当前有多少个聚类
- **平均大小**：每个聚类平均包含多少事件
- **事件总数**：所有聚类包含的事件总数

### 查看未聚类事件

如果有很多事件没被聚类，可能的原因：
1. 这些事件相互之间不够相似
2. 这些事件不满足时间窗口约束
3. 这些事件缺少embedding

**建议操作**：
- 手动检查这些事件
- 考虑降低相似度阈值
- 为缺失embedding的事件生成向量

## 🎨 聚类标题生成

聚类标题由GPT-4o-mini自动生成，考虑了：
- 成员事件的标题
- 事件类型分布
- 时间信息
- 语义主题

如果自动生成的标题不理想，未来版本将支持手动编辑。

## 🔄 增量聚类机制

### 工作原理

系统采用增量聚类，而非每次全量重新聚类：

1. **候选选择**：只处理：
   - 未被聚类的新事件
   - 最近30天内更新/访问的事件
   - 保留已有聚类的稳定状态

2. **高效处理**：
   - 小规模更新：秒级完成
   - 大规模初始聚类：数十秒到几分钟

### 何时需要重新聚类

建议在以下情况重新执行聚类：

- 新增了大量事件后（如批量整理对话）
- 修改了聚类参数
- 定期整理（如每周一次）
- 发现查询结果有大量未聚类事件

### 强制全量聚类

如需全量重新聚类，可在代码中设置：
```dart
await clusteringService.organizeGraph(
  forceRecluster: true,  // 强制重新聚类所有事件
);
```

## 🐛 故障排查

### 问题1：聚类结果为空

**检查项**：
1. 事件总数是否 >= 2？
2. 事件是否都有embedding？
3. 事件之间的相似度是否 >= 阈值？

**解决方法**：
- 生成更多事件
- 确保所有事件有embedding
- 降低相似度阈值

### 问题2：聚类质量差

**表现**：
- 不相关的事件被聚在一起
- 相关的事件没被聚在一起

**可能原因**：
- Embedding质量问题
- 事件描述不够详细
- 参数设置不合理

**解决方法**：
- 改进事件描述，添加更多上下文
- 检查embedding生成逻辑
- 调整聚类参数

### 问题3：性能问题

**表现**：
- 聚类耗时过长
- 应用卡顿

**原因**：
- 事件数量过多（>500）
- 聚类算法复杂度高

**解决方法**：
- 分批处理事件
- 使用更高效的聚类算法（如HDBSCAN）
- 限制候选事件数量

## 🚀 未来优化

计划中的功能改进：

1. **自动触发聚类**：系统空闲时自动执行
2. **聚类质量评估**：显示聚类质量指标
3. **手动调整**：允许用户合并/拆分聚类
4. **聚类重命名**：自定义聚类标题
5. **多层聚类**：支持聚类的聚类
6. **向量索引优化**：使用专门的向量数据库

## 📚 相关文档

- `CLUSTERING_SETUP.md` - 安装和配置指南
- `lib/services/semantic_clustering_service.dart` - 聚类服务实现
- `lib/views/kg_test_page.dart` - UI实现

## 💡 最佳实践

1. **定期整理**：每周运行一次聚类，保持知识图谱整洁
2. **高质量事件**：记录事件时添加详细描述，提高聚类准确性
3. **参数调优**：根据你的使用场景调整聚类参数
4. **及时反馈**：发现聚类问题及时调整，避免错误累积
5. **向量管理**：确保所有新事件都生成了embedding
